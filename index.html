<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QuickSight Custom Visual - Kaplan Meier</title>
  <style>
    :root {
      --bg: #ededed;
      --panel-bg: #efefef;
      --ink: #2e3188;
      --text: #4c4c4c;
      --muted: #676767;
      --line: #313286;
      --median: #c62828;
      --grid: #d0d0d0;
      --ui-font: "Amazon Ember", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--ui-font);
    }

    body {
      display: flex;
      min-height: 100vh;
    }

    .app {
      flex: 1;
      min-width: 0;
      min-height: 0;
      padding: clamp(6px, 1vw, 14px);
      display: flex;
    }

    .panel {
      flex: 1;
      min-width: 0;
      min-height: 0;
      display: flex;
      flex-direction: column;
      background: #ffffff;
      border: 1px solid #d7d7d7;
      border-radius: 4px;
      padding: 8px 10px 10px;
      gap: 6px;
    }

    .panel-head {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      min-height: 24px;
    }

    .title {
      margin: 0;
      color: #333333;
      font-size: clamp(0.86rem, 1.1vw, 1.02rem);
      font-weight: 700;
      letter-spacing: 0.01em;
      text-transform: uppercase;
    }

    .canvas-wrap {
      flex: 0 0 auto;
      width: 100%;
      position: relative;
      height: clamp(250px, 52vh, 480px);
      border: 1px solid #ebebeb;
      padding: 4px 2px 2px;
      background: #fcfcfc;
    }

    .kpi-strip {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 4px;
      margin-top: 2px;
    }

    .kpi-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 36px;
      border-top: 1px solid #e6e6e6;
      padding-top: 3px;
    }

    .kpi-label {
      color: #6f6f6f;
      font-size: 0.66rem;
      font-weight: 600;
      line-height: 1.1;
      text-transform: none;
    }

    .kpi-value {
      color: #333333;
      font-size: 0.9rem;
      font-weight: 700;
      line-height: 1.1;
      margin-top: 2px;
      font-variant-numeric: tabular-nums;
    }

    .risk-wrap {
      overflow-x: auto;
      border-top: 1px solid #e6e6e6;
      padding-top: 4px;
    }

    .risk-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.69rem;
      color: #2f2f2f;
      table-layout: fixed;
    }

    .risk-table th,
    .risk-table td {
      border: 1px solid #e7e7e7;
      padding: 2px 4px;
      text-align: center;
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
    }

    .risk-table thead th {
      background: #f3f3f3;
      font-weight: 700;
      color: #555555;
    }

    .risk-table .row-label {
      text-align: left;
      font-weight: 700;
      background: #fafafa;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }

    .chart-error {
      margin: 0;
      color: #8b1d1d;
      font-size: 0.95rem;
      text-align: center;
      padding: 4px;
      display: none;
    }

    @media (max-width: 980px) {
      .kpi-strip {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .kpi-strip {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .canvas-wrap {
        height: clamp(220px, 48vh, 380px);
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <section class="panel">
      <header class="panel-head">
        <h1 class="title">Curva de Supervivencia - Kaplan Meier</h1>
      </header>
      <div class="canvas-wrap">
        <canvas id="kmChart" aria-label="Curva Kaplan Meier" role="img"></canvas>
      </div>
      <section class="kpi-strip" aria-label="Metricas Kaplan Meier">
        <article class="kpi-item">
          <span class="kpi-label">Pacientes</span>
          <span class="kpi-value" id="metaPacientes">0</span>
        </article>
        <article class="kpi-item">
          <span class="kpi-label">Eventos</span>
          <span class="kpi-value" id="metaEventos">0</span>
        </article>
        <article class="kpi-item">
          <span class="kpi-label">Mediana</span>
          <span class="kpi-value" id="metaMediana">--</span>
        </article>
        <article class="kpi-item">
          <span class="kpi-label">Superv. 12m</span>
          <span class="kpi-value" id="metaSurv12">--</span>
        </article>
        <article class="kpi-item">
          <span class="kpi-label">Superv. 24m</span>
          <span class="kpi-value" id="metaSurv24">--</span>
        </article>
      </section>
      <section class="risk-wrap">
        <table id="riskTable" class="risk-table" aria-label="Tabla de riesgo"></table>
      </section>
      <p id="chartError" class="chart-error"></p>
    </section>
  </main>

  <script>
    (function () {
      "use strict";

      var DEFAULT_CURVE = {
        points: [
          { x: 0, y: 1 },
          { x: 6, y: 0.93 },
          { x: 12, y: 0.82 },
          { x: 18, y: 0.7 },
          { x: 24, y: 0.58 },
          { x: 30, y: 0.49 }
        ],
        totalPatients: 0,
        totalEvents: 0,
        totalCensored: 0,
        median: 30
      };

      var chartInstance = null;
      var pluginRegistered = false;

      var dom = {
        canvas: document.getElementById("kmChart"),
        error: document.getElementById("chartError"),
        pacientes: document.getElementById("metaPacientes"),
        eventos: document.getElementById("metaEventos"),
        mediana: document.getElementById("metaMediana"),
        surv12: document.getElementById("metaSurv12"),
        surv24: document.getElementById("metaSurv24"),
        riskTable: document.getElementById("riskTable")
      };

      // URL parameter parsing from window.location.search.
      function readQueryParams() {
        return new URLSearchParams(window.location.search);
      }

      // Demo filters accepted directly from QuickSight URL params:
      // sexo (All/M/F), edadmin (min), edadmax (max), demomodo (1/0).

      function normalizeText(input, fallback) {
        if (input === null || input === undefined) {
          return fallback;
        }
        var value = String(input).replace(/\s+/g, " ").trim();
        return value || fallback;
      }

      // Numeric validation:
      // accepts only safe numeric strings and returns fallback for invalid values.
      function toSafeNumber(input, fallback) {
        if (input === null || input === undefined) {
          return fallback;
        }

        var raw = String(input).trim();
        if (!raw) {
          return fallback;
        }

        var compact = raw.replace(/\s+/g, "");
        if (!/^[+-]?[\d.,]+$/.test(compact)) {
          return fallback;
        }

        var normalized = compact;
        var lastComma = normalized.lastIndexOf(",");
        var lastDot = normalized.lastIndexOf(".");

        if (lastComma > -1 && lastDot > -1) {
          if (lastComma > lastDot) {
            normalized = normalized.replace(/\./g, "").replace(",", ".");
          } else {
            normalized = normalized.replace(/,/g, "");
          }
        } else if (lastComma > -1) {
          normalized = normalized.replace(",", ".");
        }

        var parsed = Number(normalized);
        return Number.isFinite(parsed) ? parsed : fallback;
      }

      function getFirstParamValue(params, keys) {
        var keyList = Array.isArray(keys) ? keys : [keys];
        for (var i = 0; i < keyList.length; i += 1) {
          if (params.has(keyList[i])) {
            return params.get(keyList[i]);
          }
        }
        return null;
      }

      function parseList(raw) {
        if (raw === null || raw === undefined) {
          return [];
        }

        var text = String(raw).trim();
        if (!text) {
          return [];
        }

        try {
          var parsedJson = JSON.parse(text);
          if (Array.isArray(parsedJson)) {
            return parsedJson;
          }
        } catch (errorA) {
          // keep trying
        }

        try {
          var decoded = atob(text);
          var parsedBase64 = JSON.parse(decoded);
          if (Array.isArray(parsedBase64)) {
            return parsedBase64;
          }
        } catch (errorB) {
          // keep trying
        }

        var delimiter = ",";
        if (text.indexOf("|") > -1) {
          delimiter = "|";
        } else if (text.indexOf(";") > -1) {
          delimiter = ";";
        }

        return text.split(delimiter);
      }

      function readTextList(params, keys) {
        var raw = getFirstParamValue(params, keys);
        if (raw === null || raw === undefined) {
          return [];
        }

        return parseList(raw)
          .map(function (item) {
            return normalizeText(item, "");
          })
          .filter(function (item) {
            return item.length > 0;
          });
      }

      function readNumberList(params, keys) {
        var raw = getFirstParamValue(params, keys);
        if (raw === null || raw === undefined) {
          return [];
        }

        var values = parseList(raw);
        var output = [];
        for (var i = 0; i < values.length; i += 1) {
          var n = toSafeNumber(values[i], Number.NaN);
          if (!Number.isFinite(n)) {
            continue;
          }
          output.push(n);
        }
        return output;
      }

      function toBinaryEvent(value) {
        var n = toSafeNumber(value, Number.NaN);
        return Number.isFinite(n) && n > 0 ? 1 : 0;
      }

      function makeSeededRandom(seed) {
        var state = seed % 2147483647;
        if (state <= 0) {
          state += 2147483646;
        }
        return function () {
          state = state * 16807 % 2147483647;
          return (state - 1) / 2147483646;
        };
      }

      function readNumberParam(params, keys, fallback) {
        return toSafeNumber(getFirstParamValue(params, keys), fallback);
      }

      function normalizeSexoFilter(value) {
        var key = normalizeText(value, "all").toLowerCase();
        if (key === "m" || key === "masculino" || key === "male" || key === "hombre") {
          return "M";
        }
        if (key === "f" || key === "femenino" || key === "female" || key === "mujer") {
          return "F";
        }
        return "ALL";
      }

      function isDemoModeEnabled(params) {
        var raw = normalizeText(getFirstParamValue(params, ["demomodo", "demomode", "mockmode"]), "1").toLowerCase();
        return raw !== "0" && raw !== "false" && raw !== "off";
      }

      function hasPrecomputedCurveParams(params) {
        var timeRaw = getFirstParamValue(params, ["kmtiempo", "tiempokm"]);
        var survRaw = getFirstParamValue(params, ["kmsupervivencia", "kmsurv", "supervivenciakm"]);
        return !!(timeRaw && survRaw);
      }

      // Hardcoded synthetic table (fixed cohort) for demo without backend.
      // Structure aligned with KM inputs: cic, meses_supervivencia, exitus_corte
      // plus helper dimensions for filtering: sexo, edad.
      function buildHardcodedSyntheticTable5000() {
        var rng = makeSeededRandom(20260225);
        var total = 5000;
        var rows = [];

        // Calibrated synthetic profile (deterministic) based on provided CSV schema
        // and tuned to realistic KM demo behaviour.
        var ageRanges = [
          { min: 30, max: 49 },
          { min: 50, max: 59 },
          { min: 60, max: 69 },
          { min: 70, max: 79 },
          { min: 80, max: 90 }
        ];
        var ageBucketProb = [0.038, 0.172, 0.41, 0.317, 0.063];
        var maleProbByBucket = [0.66, 0.588, 0.593, 0.73, 0.7];
        var eventProbMale = [0.54, 0.62, 0.70, 0.80, 0.86];
        var eventProbFemale = [0.44, 0.53, 0.62, 0.74, 0.80];
        var scaleMale = [24, 21, 18, 15, 13];
        var scaleFemale = [27, 23, 20, 16, 14];
        var weibullShape = 1.1;

        function pickIndex(probabilities) {
          var r = rng();
          var cum = 0;
          for (var p = 0; p < probabilities.length; p += 1) {
            cum += probabilities[p];
            if (r <= cum) {
              return p;
            }
          }
          return probabilities.length - 1;
        }

        for (var i = 0; i < total; i += 1) {
          var bucket = pickIndex(ageBucketProb);
          var range = ageRanges[bucket];
          var edad = Math.floor(range.min + rng() * (range.max - range.min + 1));
          var sexo = rng() < maleProbByBucket[bucket] ? "M" : "F";
          var eventProb = sexo === "M" ? eventProbMale[bucket] : eventProbFemale[bucket];
          var evento = rng() < eventProb ? 1 : 0;
          var meses = 1;

          if (evento === 1) {
            var scale = sexo === "M" ? scaleMale[bucket] : scaleFemale[bucket];
            var u = rng();
            meses = Math.ceil(scale * Math.pow(-Math.log(1 - u), 1 / weibullShape));
          } else {
            // Censored cases usually carry longer follow-up.
            meses = Math.ceil(10 + (60 - 10) * Math.pow(rng(), 0.35));
          }

          if (meses < 1) {
            meses = 1;
          } else if (meses > 60) {
            meses = 60;
          }

          var cic = "demo_" + String(i + 1);
          var codigopaciente = 100000 + i;

          rows.push({
            codigopaciente: codigopaciente,
            cic: cic,
            sexo: sexo,
            edad: edad,
            meses_supervivencia: meses,
            exitus_corte: evento
          });
        }

        return rows;
      }

      var HARD_CODED_SYNTHETIC_TABLE_5000 = buildHardcodedSyntheticTable5000();
      window.HARD_CODED_SYNTHETIC_TABLE_5000 = HARD_CODED_SYNTHETIC_TABLE_5000;

      function getDemoFilteredRows(params) {
        var data = HARD_CODED_SYNTHETIC_TABLE_5000;
        var sexoFilter = normalizeSexoFilter(getFirstParamValue(params, ["sexo", "filtrosexo"]));
        var edadMin = readNumberParam(params, ["edadmin", "edad_min"], 0);
        var edadMax = readNumberParam(params, ["edadmax", "edad_max"], 120);

        if (edadMin > edadMax) {
          var tmp = edadMin;
          edadMin = edadMax;
          edadMax = tmp;
        }

        var filtered = [];
        for (var i = 0; i < data.length; i += 1) {
          var row = data[i];
          if (sexoFilter !== "ALL" && row.sexo !== sexoFilter) {
            continue;
          }
          if (row.edad < edadMin || row.edad > edadMax) {
            continue;
          }
          filtered.push({
            cic: row.cic,
            meses: row.meses_supervivencia,
            evento: row.exitus_corte
          });
        }

        return filtered;
      }

      function readRawRowsFromJson(params) {
        var raw = getFirstParamValue(params, ["kmrows", "kmjson", "datoskm", "rowsjson"]);
        if (raw === null || raw === undefined) {
          return [];
        }

        var parsed = parseList(raw);
        if (!parsed.length || typeof parsed[0] !== "object") {
          return [];
        }

        var rows = [];
        for (var i = 0; i < parsed.length; i += 1) {
          var current = parsed[i];
          if (!current || typeof current !== "object") {
            continue;
          }

          var cic = normalizeText(
            current.cic || current.CIC || current.codigopaciente || current.CODIGOPACIENTE || ("p" + String(i + 1)),
            "p" + String(i + 1)
          );
          var mesesRaw = current.mesessupervivencia || current.meses_supervivencia || current.MESES_SUPERVIVENCIA;
          var eventoRaw = current.exituscorte || current.exitus_corte || current.EXITUS_CORTE;
          var meses = toSafeNumber(mesesRaw, Number.NaN);

          if (!Number.isFinite(meses) || meses < 0) {
            continue;
          }

          rows.push({
            cic: cic,
            meses: meses,
            evento: toBinaryEvent(eventoRaw)
          });
        }

        return rows;
      }

      function readRawRowsFromColumns(params) {
        var cicList = readTextList(params, ["kmcic", "datoscic", "cic"]);
        var mesesList = readNumberList(params, ["kmmeses", "datoskmmeses", "mesessupervivencia"]);
        var eventoList = readTextList(params, ["kmevento", "datoskmevento", "exituscorte"]);

        var size = Math.max(cicList.length, mesesList.length, eventoList.length);
        if (size < 1) {
          return [];
        }

        var rows = [];
        for (var i = 0; i < size; i += 1) {
          var meses = toSafeNumber(mesesList[i], Number.NaN);
          if (!Number.isFinite(meses) || meses < 0) {
            continue;
          }

          rows.push({
            cic: normalizeText(cicList[i], "p" + String(i + 1)),
            meses: meses,
            evento: toBinaryEvent(eventoList[i])
          });
        }

        return rows;
      }

      function collapseRowsByPatient(rows) {
        var map = {};
        for (var i = 0; i < rows.length; i += 1) {
          var row = rows[i];
          var key = normalizeText(row.cic, "p" + String(i + 1));

          if (!map[key]) {
            map[key] = {
              cic: key,
              meses: row.meses,
              evento: row.evento
            };
            continue;
          }

          if (row.meses > map[key].meses) {
            map[key].meses = row.meses;
          }
          if (row.evento > map[key].evento) {
            map[key].evento = row.evento;
          }
        }

        var patients = [];
        var keys = Object.keys(map);
        for (var j = 0; j < keys.length; j += 1) {
          patients.push(map[keys[j]]);
        }
        return patients;
      }

      function computeMedian(points) {
        for (var i = 0; i < points.length; i += 1) {
          if (points[i].y <= 0.5) {
            return points[i].x;
          }
        }
        return null;
      }

      function getSurvivalAtMonth(points, month) {
        var value = 1;
        for (var i = 0; i < points.length; i += 1) {
          if (points[i].x <= month) {
            value = points[i].y;
          } else {
            break;
          }
        }
        return value;
      }

      function buildRiskTable(points, timeline, totalPatients) {
        var maxObserved = 0;
        for (var i = 0; i < points.length; i += 1) {
          if (points[i].x > maxObserved) {
            maxObserved = points[i].x;
          }
        }
        var maxMonth = Math.max(60, Math.ceil(maxObserved / 6) * 6);
        var ticks = [];
        for (var t = 0; t <= maxMonth; t += 6) {
          ticks.push(t);
        }

        var atRisk = [];
        var events = [];
        var censored = [];
        var survival = [];

        for (var k = 0; k < ticks.length; k += 1) {
          var tick = ticks[k];
          var state = {
            atRisk: totalPatients,
            events: 0,
            censored: 0,
            survival: getSurvivalAtMonth(points, tick)
          };

          for (var j = 0; j < timeline.length; j += 1) {
            if (timeline[j].time <= tick) {
              state.atRisk = timeline[j].atRisk;
              state.events = timeline[j].eventsCum;
              state.censored = timeline[j].censoredCum;
              state.survival = timeline[j].survival;
            } else {
              break;
            }
          }

          atRisk.push(state.atRisk);
          events.push(state.events);
          censored.push(state.censored);
          survival.push(state.survival);
        }

        return {
          ticks: ticks,
          atRisk: atRisk,
          events: events,
          censored: censored,
          survival: survival
        };
      }

      function computeKaplanMeierFromPatients(patients) {
        if (!patients.length) {
          return null;
        }

        var totalEvents = 0;
        var totalCensored = 0;
        var byTime = {};
        for (var i = 0; i < patients.length; i += 1) {
          var t = patients[i].meses;
          var tKey = String(t);
          if (!byTime[tKey]) {
            byTime[tKey] = { events: 0, censored: 0, time: t };
          }
          if (patients[i].evento === 1) {
            byTime[tKey].events += 1;
            totalEvents += 1;
          } else {
            byTime[tKey].censored += 1;
            totalCensored += 1;
          }
        }

        var orderedTimes = Object.keys(byTime)
          .map(function (key) {
            return byTime[key].time;
          })
          .sort(function (a, b) {
            return a - b;
          });

        var nAtRisk = patients.length;
        var surv = 1;
        var points = [{ x: 0, y: 1 }];
        var timeline = [];
        var cumulativeEvents = 0;
        var cumulativeCensored = 0;

        for (var j = 0; j < orderedTimes.length; j += 1) {
          var time = orderedTimes[j];
          var bucket = byTime[String(time)];
          var d = bucket.events;
          var c = bucket.censored;
          var atRiskBefore = nAtRisk;
          cumulativeEvents += d;
          cumulativeCensored += c;

          if (nAtRisk > 0 && d > 0) {
            surv = surv * (1 - d / nAtRisk);
          }

          points.push({ x: time, y: surv });
          timeline.push({
            time: time,
            atRisk: atRiskBefore,
            eventsCum: cumulativeEvents,
            censoredCum: cumulativeCensored,
            survival: surv
          });
          nAtRisk -= (d + c);
          if (nAtRisk < 0) {
            nAtRisk = 0;
          }
        }

        var risk = buildRiskTable(points, timeline, patients.length);

        return {
          points: points,
          timeline: timeline,
          risk: risk,
          totalPatients: patients.length,
          totalEvents: totalEvents,
          totalCensored: totalCensored,
          median: computeMedian(points),
          surv12: getSurvivalAtMonth(points, 12),
          surv24: getSurvivalAtMonth(points, 24)
        };
      }

      function readPrecomputedCurve(params) {
        var times = readNumberList(params, ["kmtiempo", "tiempokm"]);
        var surv = readNumberList(params, ["kmsupervivencia", "kmsurv", "supervivenciakm"]);

        var size = Math.min(times.length, surv.length);
        if (size < 2) {
          return DEFAULT_CURVE;
        }

        var pairs = [];
        for (var i = 0; i < size; i += 1) {
          var t = toSafeNumber(times[i], Number.NaN);
          var s = toSafeNumber(surv[i], Number.NaN);
          if (!Number.isFinite(t) || !Number.isFinite(s)) {
            continue;
          }
          if (t < 0) {
            continue;
          }
          if (s < 0) {
            s = 0;
          }
          if (s > 1) {
            s = 1;
          }
          pairs.push({ x: t, y: s });
        }

        if (pairs.length < 2) {
          return DEFAULT_CURVE;
        }

        pairs.sort(function (a, b) {
          return a.x - b.x;
        });

        if (pairs[0].x > 0) {
          pairs.unshift({ x: 0, y: 1 });
        }

        var totalPatients = toSafeNumber(getFirstParamValue(params, ["kmtotalpacientes", "kmtotal"]), 0);
        var totalEvents = toSafeNumber(getFirstParamValue(params, ["kmtotaleventos", "kmeventos"]), 0);
        var totalCensored = toSafeNumber(getFirstParamValue(params, ["kmtotalcensurados", "kmcensurados"]), 0);
        if (!Number.isFinite(totalCensored) || totalCensored <= 0) {
          totalCensored = Math.max(0, totalPatients - totalEvents);
        }
        var risk = buildRiskTable(pairs, [], totalPatients);

        return {
          points: pairs,
          timeline: [],
          risk: risk,
          totalPatients: totalPatients,
          totalEvents: totalEvents,
          totalCensored: totalCensored,
          median: computeMedian(pairs),
          surv12: getSurvivalAtMonth(pairs, 12),
          surv24: getSurvivalAtMonth(pairs, 24)
        };
      }

      // Render switching logic:
      // - If raw rows arrive in URL, curve is computed inside the visual.
      // - If not, demo mode can generate an embedded filtered cohort (sexo/edadmin/edadmax).
      // - If demo mode is disabled, visual reads a pre-aggregated KM curve.
      function buildConfigFromQuery(params) {
        var rawRows = readRawRowsFromJson(params);
        if (!rawRows.length) {
          rawRows = readRawRowsFromColumns(params);
        }

        if (rawRows.length) {
          var patients = collapseRowsByPatient(rawRows);
          var computed = computeKaplanMeierFromPatients(patients);
          if (computed) {
            return computed;
          }
        }

        if (hasPrecomputedCurveParams(params)) {
          return readPrecomputedCurve(params);
        }

        if (isDemoModeEnabled(params)) {
          var demoRows = getDemoFilteredRows(params);
          var demoPatients = collapseRowsByPatient(demoRows);
          var demoComputed = computeKaplanMeierFromPatients(demoPatients);
          if (demoComputed) {
            return demoComputed;
          }
        }

        return readPrecomputedCurve(params);
      }

      function formatInteger(value) {
        return new Intl.NumberFormat("es-ES", { maximumFractionDigits: 0 }).format(value);
      }

      function formatMedian(value) {
        if (!Number.isFinite(value)) {
          return "--";
        }
        return new Intl.NumberFormat("es-ES", {
          minimumFractionDigits: value % 1 === 0 ? 0 : 1,
          maximumFractionDigits: 2
        }).format(value);
      }

      function formatPercent(value, decimals) {
        if (!Number.isFinite(value)) {
          return "--";
        }
        var digits = Number.isFinite(decimals) ? decimals : 1;
        return new Intl.NumberFormat("es-ES", {
          minimumFractionDigits: digits,
          maximumFractionDigits: digits
        }).format(value * 100) + "%";
      }

      function normalizeCurveConfig(config) {
        var safe = config || {};
        if (!Array.isArray(safe.points) || safe.points.length < 2) {
          safe.points = DEFAULT_CURVE.points.slice();
        }
        if (!Number.isFinite(safe.totalPatients)) {
          safe.totalPatients = 0;
        }
        if (!Number.isFinite(safe.totalEvents)) {
          safe.totalEvents = 0;
        }
        if (!Number.isFinite(safe.totalCensored)) {
          safe.totalCensored = Math.max(0, safe.totalPatients - safe.totalEvents);
        }
        if (!Number.isFinite(safe.median)) {
          safe.median = computeMedian(safe.points);
        }
        if (!Number.isFinite(safe.surv12)) {
          safe.surv12 = getSurvivalAtMonth(safe.points, 12);
        }
        if (!Number.isFinite(safe.surv24)) {
          safe.surv24 = getSurvivalAtMonth(safe.points, 24);
        }
        if (!safe.risk || !Array.isArray(safe.risk.ticks)) {
          safe.risk = buildRiskTable(safe.points, safe.timeline || [], safe.totalPatients || 0);
        }
        return safe;
      }

      function renderRiskTable(config) {
        if (!dom.riskTable) {
          return;
        }

        var risk = config.risk || {
          ticks: [],
          atRisk: [],
          events: [],
          censored: [],
          survival: []
        };

        var header = "<thead><tr><th>Mes</th>";
        for (var h = 0; h < risk.ticks.length; h += 1) {
          header += "<th>" + formatInteger(risk.ticks[h]) + "</th>";
        }
        header += "</tr></thead>";

        function buildDataRow(label, values, formatter) {
          var row = "<tr><td class=\"row-label\">" + label + "</td>";
          for (var i = 0; i < risk.ticks.length; i += 1) {
            var v = values[i];
            row += "<td>" + formatter(v) + "</td>";
          }
          row += "</tr>";
          return row;
        }

        function intOrDash(value) {
          return Number.isFinite(value) ? formatInteger(value) : "--";
        }

        function survOrDash(value) {
          return Number.isFinite(value) ? formatPercent(value, 0) : "--";
        }

        var body = "<tbody>";
        body += buildDataRow("En riesgo", risk.atRisk || [], intOrDash);
        body += buildDataRow("Eventos", risk.events || [], intOrDash);
        body += buildDataRow("Censurados", risk.censored || [], intOrDash);
        body += buildDataRow("Supervivencia", risk.survival || [], survOrDash);
        body += "</tbody>";

        dom.riskTable.innerHTML = header + body;
      }

      function setMeta(config) {
        dom.pacientes.textContent = formatInteger(config.totalPatients || 0);
        dom.eventos.textContent = formatInteger(config.totalEvents || 0);
        dom.mediana.textContent = Number.isFinite(config.median) ? (formatMedian(config.median) + "m") : "--";
        dom.surv12.textContent = formatPercent(config.surv12, 1);
        dom.surv24.textContent = formatPercent(config.surv24, 1);
      }

      function showError(message) {
        dom.error.textContent = message;
        dom.error.style.display = "block";
      }

      function clearError() {
        dom.error.textContent = "";
        dom.error.style.display = "none";
      }

      function registerPlugins() {
        if (pluginRegistered || !window.Chart) {
          return;
        }

        window.Chart.register({
          id: "medianGuides",
          afterDatasetsDraw: function (chart, args, pluginOptions) {
            if (!pluginOptions || !Number.isFinite(pluginOptions.median)) {
              return;
            }

            var xScale = chart.scales.x;
            var yScale = chart.scales.y;
            if (!xScale || !yScale) {
              return;
            }

            var xMed = xScale.getPixelForValue(pluginOptions.median);
            var yHalf = yScale.getPixelForValue(0.5);
            var yBottom = yScale.getPixelForValue(0);
            var xZero = xScale.getPixelForValue(0);
            var ctx = chart.ctx;

            ctx.save();
            ctx.strokeStyle = "#c62828";
            ctx.lineWidth = 1.5;
            ctx.setLineDash([6, 4]);

            ctx.beginPath();
            ctx.moveTo(xZero, yHalf);
            ctx.lineTo(xMed, yHalf);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(xMed, yBottom);
            ctx.lineTo(xMed, yHalf);
            ctx.stroke();

            ctx.setLineDash([]);
            ctx.fillStyle = "#c62828";
            ctx.font = "600 11px Amazon Ember, Segoe UI, Arial, sans-serif";
            ctx.textAlign = "left";
            ctx.textBaseline = "bottom";
            ctx.fillText("Mediana: " + formatMedian(pluginOptions.median) + "m", xMed + 6, yHalf - 4);
            ctx.restore();
          }
        });

        pluginRegistered = true;
      }

      async function ensureChartJs() {
        if (window.Chart) {
          return;
        }

        await new Promise(function (resolve, reject) {
          var script = document.createElement("script");
          script.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js";
          script.async = true;
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }

      function destroyChart() {
        if (chartInstance) {
          chartInstance.destroy();
          chartInstance = null;
        }
      }

      function renderCurve(config) {
        destroyChart();
        clearError();

        if (!config.points || config.points.length < 2) {
          showError("No hay datos validos para dibujar la curva.");
          return;
        }

        var maxX = 60;
        if (config.risk && Array.isArray(config.risk.ticks) && config.risk.ticks.length) {
          maxX = config.risk.ticks[config.risk.ticks.length - 1];
        }

        chartInstance = new window.Chart(dom.canvas, {
          type: "line",
          data: {
            datasets: [
              {
                label: "S(t)",
                data: config.points,
                borderColor: "#313286",
                backgroundColor: "#313286",
                borderWidth: 3,
                pointRadius: 0,
                pointHoverRadius: 4,
                stepped: "after",
                tension: 0
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            parsing: true,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  title: function (items) {
                    return "Meses: " + formatMedian(items[0].parsed.x);
                  },
                  label: function (context) {
                    return "Supervivencia: " + formatPercent(context.parsed.y, 1);
                  }
                }
              },
              medianGuides: {
                median: config.median
              }
            },
            scales: {
              x: {
                type: "linear",
                min: 0,
                max: maxX,
                title: {
                  display: true,
                  text: "Meses",
                  color: "#5d5d5d",
                  font: {
                    family: "Amazon Ember, Segoe UI, Arial, sans-serif",
                    weight: "700"
                  }
                },
                ticks: {
                  color: "#5d5d5d",
                  stepSize: 10
                },
                grid: {
                  color: "#d0d0d0",
                  borderDash: [2, 4]
                }
              },
              y: {
                min: 0,
                max: 1,
                title: {
                  display: true,
                  text: "Supervivencia",
                  color: "#5d5d5d",
                  font: {
                    family: "Amazon Ember, Segoe UI, Arial, sans-serif",
                    weight: "700"
                  }
                },
                ticks: {
                  color: "#5d5d5d",
                  callback: function (value) {
                    return String(Math.round(Number(value) * 100)) + "%";
                  }
                },
                grid: {
                  color: "#d0d0d0",
                  borderDash: [2, 4]
                }
              }
            }
          }
        });
      }

      async function init() {
        var params = readQueryParams();
        var config = normalizeCurveConfig(buildConfigFromQuery(params));

        setMeta(config);
        renderRiskTable(config);

        try {
          await ensureChartJs();
          registerPlugins();
          renderCurve(config);
        } catch (error) {
          showError("No se pudo cargar Chart.js desde CDN.");
        }
}

      init();
    })();
  </script>
</body>
</html>
