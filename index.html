<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QuickSight Custom Visual - Dashboard Replica</title>
  <style>
    :root {
      --bg: #ededed;
      --panel-bg: #efefef;
      --card-bg: #dddcd6;
      --ink: #2e3188;
      --text: #4c4c4c;
      --muted: #676767;
      --line: #313286;
      --male: #312f86;
      --female: #e783b7;
      --ring-1: #3fb4ac;
      --ring-2: #e77fb5;
      --ring-3: #ff7a00;
      --ring-4: #9d9a90;
      --ring-5: #33348f;
      --kpi-border: #a8a8a3;
      --ui-font: "Amazon Ember", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      --num-font: "Amazon Ember", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--ui-font);
    }

    body {
      display: flex;
      min-height: 100vh;
    }

    #app {
      flex: 1;
      min-width: 0;
      min-height: 0;
      padding: clamp(6px, 1vw, 14px);
      display: flex;
      justify-content: center;
    }

    .dashboard {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: clamp(8px, 1.2vw, 14px);
      min-width: 0;
      min-height: 0;
    }

    .summary {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 0;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .kpi-row {
      flex: 1;
      min-width: min(100%, 500px);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .kpi-card {
      flex: 1 1 160px;
      min-width: 0;
      background: var(--card-bg);
      border: 1px solid var(--kpi-border);
      border-radius: 12px;
      padding: 8px 12px 10px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.35);
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 72px;
    }

    .kpi-title {
      margin: 0;
      color: var(--muted);
      font-size: clamp(0.78rem, 1.15vw, 1.02rem);
      font-weight: 700;
      font-family: var(--ui-font);
    }

    .kpi-value {
      margin: 8px 0 0;
      color: #2f2f2f;
      font-size: clamp(1.05rem, 2.7vw, 2.15rem);
      line-height: 1;
      font-weight: 700;
      font-family: var(--num-font);
      letter-spacing: 0;
      font-variant-numeric: tabular-nums;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      grid-template-areas:
        "line donut"
        "bars donut";
      gap: 8px;
      min-width: 0;
    }

    .panel {
      background: var(--panel-bg);
      border: 1.5px solid var(--ink);
      border-radius: 22px;
      padding: 8px 12px 10px;
      display: flex;
      flex-direction: column;
      min-width: 0;
      min-height: 0;
    }

    .panel-title {
      margin: 0 0 4px;
      color: var(--ink);
      text-align: center;
      font-size: clamp(0.95rem, 1.45vw, 1.95rem);
      font-weight: 700;
      letter-spacing: 0;
      font-family: var(--ui-font);
    }

    .panel-line {
      grid-area: line;
    }

    .panel-bars {
      grid-area: bars;
    }

    .panel-donut {
      grid-area: donut;
    }

    .legend-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 4px 0 2px;
      flex-wrap: wrap;
      color: #606060;
      font-size: clamp(0.76rem, 1.1vw, 0.98rem);
      font-family: var(--ui-font);
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .dot {
      width: 11px;
      height: 11px;
      border-radius: 50%;
      display: inline-block;
    }

    .dot-male {
      background: var(--male);
    }

    .dot-female {
      background: var(--female);
    }

    .canvas-wrap {
      flex: 1;
      min-height: 0;
      position: relative;
      width: 100%;
    }
    .panel-line .canvas-wrap {
      height: clamp(190px, 30vh, 300px);
    }

    .panel-bars .canvas-wrap {
      height: clamp(170px, 26vh, 260px);
    }

    .panel-donut .canvas-wrap {
      height: clamp(360px, 60vh, 600px);
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }

    .chart-error {
      margin: 0;
      color: #8b1d1d;
      font-size: 0.95rem;
      padding: 10px;
      text-align: center;
    }

    @media (max-width: 1200px) {
      .charts-grid {
        grid-template-columns: 1fr;
        grid-template-areas:
          "line"
          "bars"
          "donut";
      }

      .panel-donut .canvas-wrap {
        height: clamp(280px, 42vh, 420px);
      }
    }

    @media (max-width: 680px) {
      .kpi-row {
        min-width: 0;
      }

      .kpi-card {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>
  <main id="app">
    <div class="dashboard">
      <section id="summarySection" class="summary">
        <div class="top-row">
          <div class="kpi-row">
            <article class="kpi-card">
              <p class="kpi-title">Numero de Pacientes</p>
              <p class="kpi-value" id="kpiPacientes">0</p>
            </article>
            <article class="kpi-card">
              <p class="kpi-title">Numero de Exitus</p>
              <p class="kpi-value" id="kpiExitos">0</p>
            </article>
            <article class="kpi-card">
              <p class="kpi-title">Numero de Protocolos</p>
              <p class="kpi-value" id="kpiProtocolos">0</p>
            </article>
          </div>
        </div>

        <div class="charts-grid">
          <section class="panel panel-line">
            <h2 class="panel-title">Numero de pacientes que inician el tratamiento cada anio</h2>
            <div class="canvas-wrap">
              <canvas id="lineChart" aria-label="Grafico de linea por anio" role="img"></canvas>
            </div>
          </section>

          <section class="panel panel-donut">
            <h2 class="panel-title">Numero de pacientes tratados por hospital</h2>
            <div class="canvas-wrap">
              <canvas id="donutChart" aria-label="Grafico donut por hospital" role="img"></canvas>
            </div>
          </section>

          <section class="panel panel-bars">
            <h2 class="panel-title">Numero de pacientes por edad y sexo</h2>
            <div class="legend-row">
              <span class="legend-item"><span class="dot dot-male"></span>Masculino</span>
              <span class="legend-item"><span class="dot dot-female"></span>Femenino</span>
            </div>
            <div class="canvas-wrap">
              <canvas id="barChart" aria-label="Grafico de barras por edad y sexo" role="img"></canvas>
            </div>
          </section>
        </div>
      </section>
    </div>
  </main>

  <script>
    (function () {
      "use strict";

      /*
       * Defaults based on the reference images.
       * Every value can be replaced from URL query parameters.
       */
      var DEFAULTS = {
        kpi: {
          pacientes: 5559,
          exitus: 3350,
          protocolos: 240
        },
        line: {
          labels: ["2019", "2020", "2021", "2022", "2023", "2024", "2025"],
          values: [459, 778, 910, 991, 939, 983, 519]
        },
        bars: {
          labels: ["Menos de 50 anios", "50-59 anios", "60-69 anios", "70-79 anios", "Mas de 80 anios"],
          hombre: [140, 563, 1351, 1285, 247],
          mujer: [72, 395, 925, 475, 106]
        },
        donut: {
          labels: ["OD", "HUC", "HUB", "HUA", "HGU"],
          values: [1660, 1095, 991, 936, 877],
          colors: ["#3fb4ac", "#e77fb5", "#ff7a00", "#9d9a90", "#33348f"]
        }
      };
      var chartInstances = {
        line: null,
        bars: null,
        donut: null
      };
      var pluginsRegistered = false;

      var dom = {
        kpiPacientes: document.getElementById("kpiPacientes"),
        kpiExitos: document.getElementById("kpiExitos"),
        kpiProtocolos: document.getElementById("kpiProtocolos")
      };

      var rootStyles = window.getComputedStyle(document.documentElement);

      function cssVar(name, fallback) {
        var value = rootStyles.getPropertyValue(name);
        value = value ? String(value).trim() : "";
        return value || fallback;
      }

      var THEME = Object.freeze({
        ink: cssVar("--ink", "#2e3188"),
        line: cssVar("--line", "#313286"),
        male: cssVar("--male", "#312f86"),
        female: cssVar("--female", "#e783b7"),
        ring1: cssVar("--ring-1", "#3fb4ac"),
        ring2: cssVar("--ring-2", "#e77fb5"),
        ring3: cssVar("--ring-3", "#ff7a00"),
        ring4: cssVar("--ring-4", "#9d9a90"),
        ring5: cssVar("--ring-5", "#33348f"),
        axisText: "#5d5d5d",
        axisGrid: "#d0d0d0",
        outLabelLine: "#b7b7b7",
        outLabelText: "#666666",
        uiFont: cssVar("--ui-font", "Amazon Ember, Segoe UI, Helvetica Neue, Arial, sans-serif"),
        numFont: cssVar("--num-font", "Amazon Ember, Segoe UI, Helvetica Neue, Arial, sans-serif")
      });

      // URL parameter parsing entrypoint based on window.location.search.
      function readQueryParams() {
        return new URLSearchParams(window.location.search);
      }

      /*
       * Canonical URL params (alphanumeric names):
       * - KPIs: numpacientes, numexitus, numprotocolos
       * - Line chart: aniofechainicio, numpacientesanio
       * - Bar chart: tramoedadgrafico, numpacientesmasculino, numpacientesfemenino
       * - Donut chart: codhosplista, numpacientescodhosp
       * - Filters: fechainicio, fechacorte, codhosp, sexo, tramoedad
       */

      // Numeric validation:
      // - accepts "1234", "1,5", "1.5", "5.559,2"
      // - rejects non-finite values and unsafe strings
      // - returns fallback for invalid data
      function toSafeNumber(input, fallback) {
        if (input === null || input === undefined) {
          return fallback;
        }
        var raw = String(input).trim();
        if (!raw) {
          return fallback;
        }

        var compact = raw.replace(/\s+/g, "");
        if (!/^[+-]?[\d.,]+$/.test(compact)) {
          return fallback;
        }

        var normalized = compact;
        var lastComma = normalized.lastIndexOf(",");
        var lastDot = normalized.lastIndexOf(".");

        if (lastComma > -1 && lastDot > -1) {
          if (lastComma > lastDot) {
            normalized = normalized.replace(/\./g, "").replace(",", ".");
          } else {
            normalized = normalized.replace(/,/g, "");
          }
        } else if (lastComma > -1) {
          normalized = normalized.replace(",", ".");
        }

        var parsed = Number(normalized);
        return Number.isFinite(parsed) ? parsed : fallback;
      }

      function normalizeText(input, fallback) {
        if (input === null || input === undefined) {
          return fallback;
        }
        var value = String(input).replace(/\s+/g, " ").trim();
        return value || fallback;
      }

      function normalizeKeyList(keyOrKeys) {
        return Array.isArray(keyOrKeys) ? keyOrKeys : [keyOrKeys];
      }

      function getFirstParamValue(params, keyOrKeys) {
        var keys = normalizeKeyList(keyOrKeys);
        for (var i = 0; i < keys.length; i += 1) {
          if (params.has(keys[i])) {
            return params.get(keys[i]);
          }
        }
        return null;
      }

      function readTextParam(params, keyOrKeys, fallback) {
        var raw = getFirstParamValue(params, keyOrKeys);
        if (raw === null || raw === undefined) {
          return fallback;
        }
        return normalizeText(raw, fallback);
      }

      function parseList(raw) {
        if (raw === null || raw === undefined) {
          return [];
        }

        var text = String(raw).trim();
        if (!text) {
          return [];
        }

        try {
          var parsedJson = JSON.parse(text);
          if (Array.isArray(parsedJson)) {
            return parsedJson;
          }
        } catch (errorA) {
          // Ignore and continue with other formats.
        }

        try {
          var decoded = atob(text);
          var parsedBase64 = JSON.parse(decoded);
          if (Array.isArray(parsedBase64)) {
            return parsedBase64;
          }
        } catch (errorB) {
          // Ignore and continue with delimited list parsing.
        }

        var delimiter = ",";
        if (text.indexOf("|") > -1) {
          delimiter = "|";
        } else if (text.indexOf(";") > -1) {
          delimiter = ";";
        }
        return text.split(delimiter);
      }

      function readTextList(params, keyOrKeys, fallback) {
        var raw = getFirstParamValue(params, keyOrKeys);
        if (raw === null || raw === undefined) {
          return fallback.slice();
        }
        var values = parseList(raw)
          .map(function (item) {
            return normalizeText(item, "");
          })
          .filter(function (item) {
            return item.length > 0;
          });
        return values.length ? values : fallback.slice();
      }

      function readNumberList(params, keyOrKeys, fallback) {
        var raw = getFirstParamValue(params, keyOrKeys);
        if (raw === null || raw === undefined) {
          return fallback.slice();
        }
        var rawValues = parseList(raw);
        if (!rawValues.length) {
          return fallback.slice();
        }

        var result = [];
        for (var i = 0; i < rawValues.length; i += 1) {
          var value = toSafeNumber(rawValues[i], Number.NaN);
          if (!Number.isFinite(value)) {
            return fallback.slice();
          }
          result.push(value);
        }
        return result;
      }

      function normalizeSingleSeries(labels, values, fallbackLabels, fallbackValues, minLen) {
        var size = Math.min(labels.length, values.length);
        if (size < minLen) {
          return {
            labels: fallbackLabels.slice(),
            values: fallbackValues.slice()
          };
        }
        return {
          labels: labels.slice(0, size),
          values: values.slice(0, size)
        };
      }

      function normalizeGroupedSeries(labels, first, second, fallback) {
        var size = Math.min(labels.length, first.length, second.length);
        if (size < 1) {
          return {
            labels: fallback.labels.slice(),
            first: fallback.hombre.slice(),
            second: fallback.mujer.slice()
          };
        }
        return {
          labels: labels.slice(0, size),
          first: first.slice(0, size),
          second: second.slice(0, size)
        };
      }

      function buildDonutColorList(labels, hospitalCodes) {
        var palette = [
          THEME.ring1, // teal
          THEME.ring2, // pink
          THEME.ring3, // orange
          THEME.ring4, // gray
          THEME.ring5  // blue
        ];

        // Keep exact reference color mapping for known hospitals.
        var fixedByHospital = {
          od: THEME.ring1,
          huc: THEME.ring2,
          hub: THEME.ring3,
          hua: THEME.ring4,
          hgu: THEME.ring5
        };

        var output = [];
        for (var i = 0; i < labels.length; i += 1) {
          var labelToken = normalizeCompactToken(labels[i]);
          var codeToken = normalizeCompactToken(hospitalCodes[i] || "");
          var labelNoH = labelToken.replace(/^h+/, "");
          var codeNoH = codeToken.replace(/^h+/, "");
          var mapped =
            fixedByHospital[labelToken] ||
            fixedByHospital[codeToken] ||
            fixedByHospital[labelNoH] ||
            fixedByHospital[codeNoH];

          output.push(mapped || palette[i % palette.length]);
        }

        return output;
      }

      function normalizeFilterText(value) {
        return String(value || "")
          .trim()
          .toLowerCase()
          .replace(/\s+/g, " ");
      }

      function parseFilterTokens(value) {
        if (isAllFilter(value)) {
          return [];
        }
        return normalizeFilterText(value)
          .split(/[|,;]/)
          .map(function (token) {
            return token.trim();
          })
          .filter(function (token) {
            return token.length > 0;
          });
      }

      function normalizeCompactToken(value) {
        return normalizeFilterText(value).replace(/[^a-z0-9]/g, "");
      }

      function isAllFilter(value) {
        var v = normalizeFilterText(value);
        return !v || v === "todas" || v === "todos" || v === "all";
      }

      function parseDateInput(value) {
        var text = String(value || "").trim();
        if (!text) {
          return null;
        }

        var dmy = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/.exec(text);
        if (dmy) {
          var day = Number(dmy[1]);
          var month = Number(dmy[2]);
          var year = Number(dmy[3]);
          if (year > 1900 && month >= 1 && month <= 12 && day >= 1 && day <= 31) {
            return new Date(year, month - 1, day);
          }
        }

        var ymd = /^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/.exec(text);
        if (ymd) {
          var y = Number(ymd[1]);
          var m = Number(ymd[2]);
          var d = Number(ymd[3]);
          if (y > 1900 && m >= 1 && m <= 12 && d >= 1 && d <= 31) {
            return new Date(y, m - 1, d);
          }
        }

        return null;
      }

      function parseYearFromLabel(label) {
        var match = String(label || "").match(/(19|20)\d{2}/);
        return match ? Number(match[0]) : null;
      }

      function applySeriesFilters(baseConfig, filters) {
        var lineLabels = baseConfig.line.labels.slice();
        var lineValues = baseConfig.line.values.slice();
        var barLabels = baseConfig.bars.labels.slice();
        var barHombre = baseConfig.bars.first.slice();
        var barMujer = baseConfig.bars.second.slice();
        var donutLabels = baseConfig.donut.labels.slice();
        var donutValues = baseConfig.donut.values.slice();
        var donutColors = baseConfig.donut.colors.slice();
        var donutCodes = filters.hospitalCodes.slice();

        // Filter line chart by date range using year labels:
        // X axis = anio_fecha_inicio, Y axis = numero de pacientes.
        var fromDate = parseDateInput(filters.fechaInicio);
        var toDate = parseDateInput(filters.fechaCorte) || parseDateInput(filters.fechaInicioHasta);
        if (fromDate || toDate) {
          var filteredLineLabels = [];
          var filteredLineValues = [];
          for (var i = 0; i < lineLabels.length; i += 1) {
            var year = parseYearFromLabel(lineLabels[i]);
            if (year === null) {
              continue;
            }
            var allowed = true;
            if (fromDate && year < fromDate.getFullYear()) {
              allowed = false;
            }
            if (toDate && year > toDate.getFullYear()) {
              allowed = false;
            }
            if (allowed) {
              filteredLineLabels.push(lineLabels[i]);
              filteredLineValues.push(lineValues[i]);
            }
          }
          if (filteredLineLabels.length >= 2) {
            lineLabels = filteredLineLabels;
            lineValues = filteredLineValues;
          }
        }

        // Filter bars by tramoedad.
        var tramoTokens = parseFilterTokens(filters.tramoEdad);
        if (tramoTokens.length) {
          var filteredBarLabels = [];
          var filteredBarH = [];
          var filteredBarM = [];
          for (var j = 0; j < barLabels.length; j += 1) {
            var labelKey = normalizeFilterText(barLabels[j]);
            var match = tramoTokens.indexOf(labelKey) > -1;
            if (!match) {
              for (var k = 0; k < tramoTokens.length; k += 1) {
                if (labelKey.indexOf(tramoTokens[k]) > -1 || tramoTokens[k].indexOf(labelKey) > -1) {
                  match = true;
                  break;
                }
              }
            }
            if (match) {
              filteredBarLabels.push(barLabels[j]);
              filteredBarH.push(barHombre[j]);
              filteredBarM.push(barMujer[j]);
            }
          }
          if (filteredBarLabels.length) {
            barLabels = filteredBarLabels;
            barHombre = filteredBarH;
            barMujer = filteredBarM;
          }
        }

        // Filter bars by sexo by zeroing opposite series.
        var sexoKey = normalizeFilterText(filters.sexo);
        if (sexoKey === "masculino" || sexoKey === "hombre" || sexoKey === "male" || sexoKey === "1") {
          barMujer = barMujer.map(function () { return 0; });
        } else if (sexoKey === "femenino" || sexoKey === "mujer" || sexoKey === "female" || sexoKey === "2") {
          barHombre = barHombre.map(function () { return 0; });
        }

        // Filter donut by hospital/codhosp if provided.
        var hospitalTokens = parseFilterTokens(filters.hospital);
        if (hospitalTokens.length) {
          var filteredDonutLabels = [];
          var filteredDonutValues = [];
          var filteredDonutColors = [];

          for (var x = 0; x < donutLabels.length; x += 1) {
            var labelNorm = normalizeFilterText(donutLabels[x]);
            var codeNorm = normalizeFilterText(donutCodes[x] || "");
            var labelCompact = normalizeCompactToken(labelNorm);
            var codeCompact = normalizeCompactToken(codeNorm);
            var labelNoH = labelCompact.replace(/^h+/, "");
            var codeNoH = codeCompact.replace(/^h+/, "");
            var matchesHospital = false;

            for (var h = 0; h < hospitalTokens.length; h += 1) {
              var token = hospitalTokens[h];
              var tokenCompact = normalizeCompactToken(token);
              var tokenNoH = tokenCompact.replace(/^h+/, "");
              if (
                labelNorm === token ||
                codeNorm === token ||
                labelCompact === tokenCompact ||
                codeCompact === tokenCompact ||
                labelNoH === tokenNoH ||
                codeNoH === tokenNoH
              ) {
                matchesHospital = true;
                break;
              }
            }

            if (matchesHospital) {
              filteredDonutLabels.push(donutLabels[x]);
              filteredDonutValues.push(donutValues[x]);
              filteredDonutColors.push(donutColors[x]);
            }
          }

          if (filteredDonutLabels.length) {
            donutLabels = filteredDonutLabels;
            donutValues = filteredDonutValues;
            donutColors = filteredDonutColors;
          }
        }

        return {
          line: {
            labels: lineLabels,
            values: lineValues
          },
          bars: {
            labels: barLabels,
            first: barHombre,
            second: barMujer
          },
          donut: {
            labels: donutLabels,
            values: donutValues,
            colors: donutColors
          }
        };
      }

      function buildConfigFromQuery(params) {
        // Chart mappings requested:
        // - Line: X=anio_fecha_inicio, Y=numero de pacientes
        // - Bars: X=tramo edad, Y=numero de pacientes (Masculino/Femenino)
        // - Donut: codhosp vs numero de pacientes
        var lineLabels = readTextList(
          params,
          ["aniofechainicio", "anioinicio", "lineanios", "line_anios"],
          DEFAULTS.line.labels
        );
        var lineValues = readNumberList(
          params,
          ["numpacientesanio", "numpacienteslinea", "linevalores", "line_valores"],
          DEFAULTS.line.values
        );
        var lineSeries = normalizeSingleSeries(
          lineLabels,
          lineValues,
          DEFAULTS.line.labels,
          DEFAULTS.line.values,
          2
        );

        var barLabels = readTextList(
          params,
          ["tramoedadgrafico", "tramoedadlabels", "edadlabels", "edad_labels"],
          DEFAULTS.bars.labels
        );
        var barHombre = readNumberList(
          params,
          ["numpacientesmasculino", "numpacienteshombre", "edadhombres", "edad_hombres"],
          DEFAULTS.bars.hombre
        );
        var barMujer = readNumberList(
          params,
          ["numpacientesfemenino", "numpacientesmujer", "edadmujeres", "edad_mujeres"],
          DEFAULTS.bars.mujer
        );
        var barSeries = normalizeGroupedSeries(barLabels, barHombre, barMujer, DEFAULTS.bars);

        var donutLabels = readTextList(
          params,
          ["codhosplista", "codhosplabels", "hospitallabels", "hospital_labels"],
          DEFAULTS.donut.labels
        );
        var donutValues = readNumberList(
          params,
          ["numpacientescodhosp", "numpacienteshospital", "hospitalvalores", "hospital_valores"],
          DEFAULTS.donut.values
        );
        var donutSeries = normalizeSingleSeries(
          donutLabels,
          donutValues,
          DEFAULTS.donut.labels,
          DEFAULTS.donut.values,
          1
        );
        var hospitalCodes = readTextList(
          params,
          ["codhospcodigos", "hospitalcodigos", "hospitalcods", "hospital_codes"],
          []
        );
        var donutColors = buildDonutColorList(donutSeries.labels, hospitalCodes);
        var hospitalFilter = readTextParam(
          params,
          ["codhosp", "hospitalfiltro", "filtrohospital", "hospital", "hospitalid"],
          "Todas"
        );
        var sexoFilter = readTextParam(params, ["sexo", "Sexo", "filtrosexo"], "Todas");
        var tramoEdadFilter = readTextParam(params, ["tramoedad", "filtrotramoedad", "filtrotramosedad"], "Todas");
        var fechaInicio = readTextParam(
          params,
          ["fechainicio", "fechainiciodesde", "filtrofechainicio", "filtrofechainiciodesde"],
          ""
        );
        var fechaInicioHasta = readTextParam(params, ["fechainiciohasta", "filtrofechainiciohasta"], "");
        var fechaCorte = readTextParam(params, ["fechacorte", "filtrofechacorte"], "");

        var filteredSeries = applySeriesFilters(
          {
            line: lineSeries,
            bars: barSeries,
            donut: {
              labels: donutSeries.labels,
              values: donutSeries.values,
              colors: donutColors
            }
          },
          {
            hospital: hospitalFilter,
            sexo: sexoFilter,
            tramoEdad: tramoEdadFilter,
            fechaInicio: fechaInicio,
            fechaInicioHasta: fechaInicioHasta,
            fechaCorte: fechaCorte,
            hospitalCodes: hospitalCodes
          }
        );

        return {
          kpi: {
            pacientes: toSafeNumber(readTextParam(params, ["numpacientes", "num_pacientes"], DEFAULTS.kpi.pacientes), DEFAULTS.kpi.pacientes),
            exitus: toSafeNumber(
              readTextParam(params, ["numexitus", "numexitos", "num_exitus", "num_exitos"], DEFAULTS.kpi.exitus),
              DEFAULTS.kpi.exitus
            ),
            protocolos: toSafeNumber(readTextParam(params, ["numprotocolos", "num_protocolos"], DEFAULTS.kpi.protocolos), DEFAULTS.kpi.protocolos)
          },
          line: filteredSeries.line,
          bars: filteredSeries.bars,
          donut: filteredSeries.donut
        };
      }

      function formatInteger(value) {
        return new Intl.NumberFormat("es-ES", {
          maximumFractionDigits: 0
        }).format(value);
      }

      function formatPercent(value) {
        return new Intl.NumberFormat("es-ES", {
          minimumFractionDigits: 1,
          maximumFractionDigits: 1
        }).format(value);
      }

      function renderKpis(config) {
        dom.kpiPacientes.textContent = formatInteger(config.kpi.pacientes);
        dom.kpiExitos.textContent = formatInteger(config.kpi.exitus);
        dom.kpiProtocolos.textContent = formatInteger(config.kpi.protocolos);
      }

      function destroyCharts() {
        if (chartInstances.line) {
          chartInstances.line.destroy();
          chartInstances.line = null;
        }
        if (chartInstances.bars) {
          chartInstances.bars.destroy();
          chartInstances.bars = null;
        }
        if (chartInstances.donut) {
          chartInstances.donut.destroy();
          chartInstances.donut = null;
        }
      }

      function showChartError(canvasId, message) {
        var canvas = document.getElementById(canvasId);
        if (!canvas) {
          return;
        }
        var wrapper = canvas.parentElement;
        canvas.remove();
        var text = document.createElement("p");
        text.className = "chart-error";
        text.textContent = message;
        wrapper.appendChild(text);
      }

      function buildValueLabelPlugin() {
        return {
          id: "valueLabels",
          afterDatasetsDraw: function (chart, args, pluginOptions) {
            if (!pluginOptions || pluginOptions.enabled === false) {
              return;
            }

            var mode = pluginOptions.mode || chart.config.type;
            var ctx = chart.ctx;
            ctx.save();
            ctx.fillStyle = pluginOptions.color || THEME.axisText;
            ctx.font = pluginOptions.font || ("600 12px " + THEME.numFont);

            if (mode === "line") {
              var lineDataset = chart.data.datasets[0];
              var lineMeta = chart.getDatasetMeta(0);
              lineMeta.data.forEach(function (point, index) {
                var value = lineDataset.data[index];
                var offset = (index === 0 || index === lineDataset.data.length - 1) ? 18 : -14;
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(formatInteger(value), point.x, point.y + offset);
              });
            }

            if (mode === "bar") {
              chart.data.datasets.forEach(function (dataset, datasetIndex) {
                var barsMeta = chart.getDatasetMeta(datasetIndex);
                barsMeta.data.forEach(function (bar, dataIndex) {
                  var value = dataset.data[dataIndex];
                  ctx.textAlign = "center";
                  ctx.textBaseline = "middle";
                  ctx.fillText(formatInteger(value), bar.x, bar.y - 10);
                });
              });
            }

            ctx.restore();
          }
        };
      }

      function buildDonutLabelPlugin() {
        return {
          id: "donutOutLabels",
          afterDatasetDraw: function (chart, args, pluginOptions) {
            if (!pluginOptions || pluginOptions.enabled === false) {
              return;
            }
            if (chart.config.type !== "doughnut") {
              return;
            }

            var dataset = chart.data.datasets[0];
            var total = dataset.data.reduce(function (sum, value) {
              return sum + value;
            }, 0);
            if (total <= 0) {
              return;
            }

            var meta = chart.getDatasetMeta(0);
            var ctx = chart.ctx;
            ctx.save();
            ctx.strokeStyle = pluginOptions.lineColor || THEME.outLabelLine;
            ctx.fillStyle = pluginOptions.textColor || THEME.outLabelText;
            ctx.lineWidth = 1;
            ctx.font = pluginOptions.font || ("500 11px " + THEME.uiFont);

            meta.data.forEach(function (arc, index) {
              var value = Number(dataset.data[index]);
              if (!Number.isFinite(value) || value <= 0) {
                return;
              }

              var midAngle = (arc.startAngle + arc.endAngle) / 2;
              var cx = arc.x;
              var cy = arc.y;
              var x1 = cx + Math.cos(midAngle) * (arc.outerRadius + 4);
              var y1 = cy + Math.sin(midAngle) * (arc.outerRadius + 4);
              var x2 = cx + Math.cos(midAngle) * (arc.outerRadius + 18);
              var y2 = cy + Math.sin(midAngle) * (arc.outerRadius + 18);
              var rightSide = Math.cos(midAngle) >= 0;
              var x3 = x2 + (rightSide ? 12 : -12);

              ctx.beginPath();
              ctx.moveTo(x1, y1);
              ctx.lineTo(x2, y2);
              ctx.lineTo(x3, y2);
              ctx.stroke();

              var percent = (value / total) * 100;
              var label = chart.data.labels[index] + " " + formatInteger(value) + " (" + formatPercent(percent) + "%)";

              ctx.textAlign = rightSide ? "left" : "right";
              ctx.textBaseline = "middle";
              ctx.fillText(label, x3 + (rightSide ? 3 : -3), y2);
            });

            ctx.restore();
          }
        };
      }

      function registerPlugins() {
        if (pluginsRegistered || !window.Chart) {
          return;
        }
        window.Chart.defaults.color = THEME.axisText;
        window.Chart.defaults.font.family = THEME.uiFont;
        window.Chart.defaults.font.size = 12;
        window.Chart.defaults.plugins.legend.labels.color = THEME.axisText;
        window.Chart.register(buildValueLabelPlugin(), buildDonutLabelPlugin());
        pluginsRegistered = true;
      }

      function buildLineChart(config) {
        var canvas = document.getElementById("lineChart");
        chartInstances.line = new window.Chart(canvas, {
          type: "line",
          data: {
            labels: config.line.labels,
            datasets: [
              {
                data: config.line.values,
                borderColor: THEME.line,
                backgroundColor: THEME.line,
                borderWidth: 3,
                tension: 0,
                pointRadius: 4,
                pointHoverRadius: 5,
                pointStyle: "rect"
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            interaction: {
              mode: "nearest",
              intersect: false
            },
            layout: {
              padding: {
                top: 8,
                right: 12,
                left: 8,
                bottom: 0
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return formatInteger(context.parsed.y);
                  }
                }
              },
              valueLabels: {
                enabled: true,
                mode: "line"
              }
            },
            scales: {
              x: {
                ticks: {
                  color: THEME.axisText,
                  font: {
                    size: 12,
                    family: THEME.uiFont
                  }
                },
                grid: {
                  color: THEME.axisGrid,
                  borderDash: [2, 4],
                  drawBorder: false
                },
                border: {
                  display: false
                }
              },
              y: {
                display: false,
                beginAtZero: false
              }
            }
          }
        });
      }

      function buildBarChart(config) {
        var canvas = document.getElementById("barChart");
        chartInstances.bars = new window.Chart(canvas, {
          type: "bar",
          data: {
            labels: config.bars.labels,
            datasets: [
              {
                label: "Masculino",
                data: config.bars.first,
                backgroundColor: THEME.male,
                borderRadius: 0,
                borderSkipped: false
              },
              {
                label: "Femenino",
                data: config.bars.second,
                backgroundColor: THEME.female,
                borderRadius: 0,
                borderSkipped: false
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            layout: {
              padding: {
                top: 14,
                right: 8,
                left: 8,
                bottom: 0
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return context.dataset.label + ": " + formatInteger(context.parsed.y);
                  }
                }
              },
              valueLabels: {
                enabled: true,
                mode: "bar",
                font: "600 11px " + THEME.numFont
              }
            },
            scales: {
              x: {
                stacked: false,
                ticks: {
                  color: THEME.axisText,
                  maxRotation: 0,
                  minRotation: 0,
                  font: {
                    size: 12,
                    family: THEME.uiFont
                  }
                },
                grid: {
                  display: false
                },
                border: {
                  display: false
                }
              },
              y: {
                display: false,
                beginAtZero: true
              }
            }
          }
        });
      }

      function buildDonutChart(config) {
        var canvas = document.getElementById("donutChart");
        chartInstances.donut = new window.Chart(canvas, {
          type: "doughnut",
          data: {
            labels: config.donut.labels,
            datasets: [
              {
                data: config.donut.values,
                backgroundColor: config.donut.colors,
                borderWidth: 0,
                hoverOffset: 2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            cutout: "60%",
            layout: {
              padding: {
                top: 24,
                right: 66,
                left: 66,
                bottom: 24
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    var values = context.dataset.data;
                    var total = values.reduce(function (sum, current) {
                      return sum + current;
                    }, 0);
                    var currentValue = Number(context.parsed) || 0;
                    var pct = total ? (currentValue / total) * 100 : 0;
                    return context.label + ": " + formatInteger(currentValue) + " (" + formatPercent(pct) + "%)";
                  }
                }
              },
              donutOutLabels: {
                enabled: true
              }
            }
          }
        });
      }

      async function ensureChartJs() {
        if (window.Chart) {
          return;
        }
        await new Promise(function (resolve, reject) {
          var script = document.createElement("script");
          script.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js";
          script.async = true;
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }

      async function renderCharts(config) {
        destroyCharts();

        try {
          await ensureChartJs();
          registerPlugins();
          buildLineChart(config);
          buildBarChart(config);
          buildDonutChart(config);
        } catch (error) {
          showChartError("lineChart", "No se pudo cargar Chart.js desde CDN.");
          showChartError("barChart", "No se pudo cargar Chart.js desde CDN.");
          showChartError("donutChart", "No se pudo cargar Chart.js desde CDN.");
        }
      }

      async function init() {
        var params = readQueryParams();
        var config = buildConfigFromQuery(params);

        renderKpis(config);
        await renderCharts(config);
      }

      init();
    })();
  </script>
</body>
</html>
