<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QuickSight Custom Visual - Kaplan Meier</title>
  <style>
    :root {
      --bg: #ededed;
      --panel-bg: #efefef;
      --ink: #2e3188;
      --text: #4c4c4c;
      --muted: #676767;
      --line: #313286;
      --median: #c62828;
      --grid: #d0d0d0;
      --ui-font: "Amazon Ember", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--ui-font);
    }

    body {
      display: flex;
      min-height: 100vh;
    }

    .app {
      flex: 1;
      min-width: 0;
      min-height: 0;
      padding: clamp(6px, 1vw, 14px);
      display: flex;
    }

    .panel {
      flex: 1;
      min-width: 0;
      min-height: 0;
      display: flex;
      flex-direction: column;
      background: var(--panel-bg);
      border: 1.5px solid var(--ink);
      border-radius: 22px;
      padding: 10px 12px 12px;
      gap: 8px;
    }

    .panel-head {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
    }

    .title {
      margin: 0;
      color: var(--ink);
      font-size: clamp(1rem, 1.6vw, 1.8rem);
      font-weight: 700;
    }

    .meta {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 12px;
      color: var(--muted);
      font-size: clamp(0.78rem, 1.1vw, 1rem);
      font-weight: 700;
    }

    .canvas-wrap {
      flex: 1;
      min-height: 0;
      width: 100%;
      position: relative;
      height: clamp(260px, 70vh, 820px);
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }

    .chart-error {
      margin: 0;
      color: #8b1d1d;
      font-size: 0.95rem;
      text-align: center;
      padding: 4px;
      display: none;
    }
  </style>
</head>
<body>
  <main class="app">
    <section class="panel">
      <header class="panel-head">
        <h1 class="title">Curva de Supervivencia - Kaplan Meier</h1>
        <div class="meta">
          <span id="metaPacientes">Pacientes: 0</span>
          <span id="metaMediana">Mediana: --</span>
        </div>
      </header>
      <div class="canvas-wrap">
        <canvas id="kmChart" aria-label="Curva Kaplan Meier" role="img"></canvas>
      </div>
      <p id="chartError" class="chart-error"></p>
    </section>
  </main>

  <script>
    (function () {
      "use strict";

      var DEFAULT_CURVE = {
        points: [
          { x: 0, y: 1 },
          { x: 6, y: 0.93 },
          { x: 12, y: 0.82 },
          { x: 18, y: 0.7 },
          { x: 24, y: 0.58 },
          { x: 30, y: 0.49 }
        ],
        totalPatients: 0,
        median: 30
      };

      var chartInstance = null;
      var pluginRegistered = false;

      var dom = {
        canvas: document.getElementById("kmChart"),
        error: document.getElementById("chartError"),
        pacientes: document.getElementById("metaPacientes"),
        mediana: document.getElementById("metaMediana")
      };

      // URL parameter parsing from window.location.search.
      function readQueryParams() {
        return new URLSearchParams(window.location.search);
      }

      function normalizeText(input, fallback) {
        if (input === null || input === undefined) {
          return fallback;
        }
        var value = String(input).replace(/\s+/g, " ").trim();
        return value || fallback;
      }

      // Numeric validation:
      // accepts only safe numeric strings and returns fallback for invalid values.
      function toSafeNumber(input, fallback) {
        if (input === null || input === undefined) {
          return fallback;
        }

        var raw = String(input).trim();
        if (!raw) {
          return fallback;
        }

        var compact = raw.replace(/\s+/g, "");
        if (!/^[+-]?[\d.,]+$/.test(compact)) {
          return fallback;
        }

        var normalized = compact;
        var lastComma = normalized.lastIndexOf(",");
        var lastDot = normalized.lastIndexOf(".");

        if (lastComma > -1 && lastDot > -1) {
          if (lastComma > lastDot) {
            normalized = normalized.replace(/\./g, "").replace(",", ".");
          } else {
            normalized = normalized.replace(/,/g, "");
          }
        } else if (lastComma > -1) {
          normalized = normalized.replace(",", ".");
        }

        var parsed = Number(normalized);
        return Number.isFinite(parsed) ? parsed : fallback;
      }

      function getFirstParamValue(params, keys) {
        var keyList = Array.isArray(keys) ? keys : [keys];
        for (var i = 0; i < keyList.length; i += 1) {
          if (params.has(keyList[i])) {
            return params.get(keyList[i]);
          }
        }
        return null;
      }

      function parseList(raw) {
        if (raw === null || raw === undefined) {
          return [];
        }

        var text = String(raw).trim();
        if (!text) {
          return [];
        }

        try {
          var parsedJson = JSON.parse(text);
          if (Array.isArray(parsedJson)) {
            return parsedJson;
          }
        } catch (errorA) {
          // keep trying
        }

        try {
          var decoded = atob(text);
          var parsedBase64 = JSON.parse(decoded);
          if (Array.isArray(parsedBase64)) {
            return parsedBase64;
          }
        } catch (errorB) {
          // keep trying
        }

        var delimiter = ",";
        if (text.indexOf("|") > -1) {
          delimiter = "|";
        } else if (text.indexOf(";") > -1) {
          delimiter = ";";
        }

        return text.split(delimiter);
      }

      function readTextList(params, keys) {
        var raw = getFirstParamValue(params, keys);
        if (raw === null || raw === undefined) {
          return [];
        }

        return parseList(raw)
          .map(function (item) {
            return normalizeText(item, "");
          })
          .filter(function (item) {
            return item.length > 0;
          });
      }

      function readNumberList(params, keys) {
        var raw = getFirstParamValue(params, keys);
        if (raw === null || raw === undefined) {
          return [];
        }

        var values = parseList(raw);
        var output = [];
        for (var i = 0; i < values.length; i += 1) {
          var n = toSafeNumber(values[i], Number.NaN);
          if (!Number.isFinite(n)) {
            continue;
          }
          output.push(n);
        }
        return output;
      }

      function toBinaryEvent(value) {
        var n = toSafeNumber(value, Number.NaN);
        return Number.isFinite(n) && n > 0 ? 1 : 0;
      }

      function readRawRowsFromJson(params) {
        var raw = getFirstParamValue(params, ["kmrows", "kmjson", "datoskm", "rowsjson"]);
        if (raw === null || raw === undefined) {
          return [];
        }

        var parsed = parseList(raw);
        if (!parsed.length || typeof parsed[0] !== "object") {
          return [];
        }

        var rows = [];
        for (var i = 0; i < parsed.length; i += 1) {
          var current = parsed[i];
          if (!current || typeof current !== "object") {
            continue;
          }

          var cic = normalizeText(
            current.cic || current.CIC || current.codigopaciente || current.CODIGOPACIENTE || ("p" + String(i + 1)),
            "p" + String(i + 1)
          );
          var mesesRaw = current.mesessupervivencia || current.meses_supervivencia || current.MESES_SUPERVIVENCIA;
          var eventoRaw = current.exituscorte || current.exitus_corte || current.EXITUS_CORTE;
          var meses = toSafeNumber(mesesRaw, Number.NaN);

          if (!Number.isFinite(meses) || meses < 0) {
            continue;
          }

          rows.push({
            cic: cic,
            meses: meses,
            evento: toBinaryEvent(eventoRaw)
          });
        }

        return rows;
      }

      function readRawRowsFromColumns(params) {
        var cicList = readTextList(params, ["kmcic", "datoscic", "cic"]);
        var mesesList = readNumberList(params, ["kmmeses", "datoskmmeses", "mesessupervivencia"]);
        var eventoList = readTextList(params, ["kmevento", "datoskmevento", "exituscorte"]);

        var size = Math.max(cicList.length, mesesList.length, eventoList.length);
        if (size < 1) {
          return [];
        }

        var rows = [];
        for (var i = 0; i < size; i += 1) {
          var meses = toSafeNumber(mesesList[i], Number.NaN);
          if (!Number.isFinite(meses) || meses < 0) {
            continue;
          }

          rows.push({
            cic: normalizeText(cicList[i], "p" + String(i + 1)),
            meses: meses,
            evento: toBinaryEvent(eventoList[i])
          });
        }

        return rows;
      }

      function collapseRowsByPatient(rows) {
        var map = {};
        for (var i = 0; i < rows.length; i += 1) {
          var row = rows[i];
          var key = normalizeText(row.cic, "p" + String(i + 1));

          if (!map[key]) {
            map[key] = {
              cic: key,
              meses: row.meses,
              evento: row.evento
            };
            continue;
          }

          if (row.meses > map[key].meses) {
            map[key].meses = row.meses;
          }
          if (row.evento > map[key].evento) {
            map[key].evento = row.evento;
          }
        }

        var patients = [];
        var keys = Object.keys(map);
        for (var j = 0; j < keys.length; j += 1) {
          patients.push(map[keys[j]]);
        }
        return patients;
      }

      function computeMedian(points) {
        for (var i = 0; i < points.length; i += 1) {
          if (points[i].y <= 0.5) {
            return points[i].x;
          }
        }
        return null;
      }

      function computeKaplanMeierFromPatients(patients) {
        if (!patients.length) {
          return null;
        }

        var byTime = {};
        for (var i = 0; i < patients.length; i += 1) {
          var t = patients[i].meses;
          var tKey = String(t);
          if (!byTime[tKey]) {
            byTime[tKey] = { events: 0, censored: 0, time: t };
          }
          if (patients[i].evento === 1) {
            byTime[tKey].events += 1;
          } else {
            byTime[tKey].censored += 1;
          }
        }

        var orderedTimes = Object.keys(byTime)
          .map(function (key) {
            return byTime[key].time;
          })
          .sort(function (a, b) {
            return a - b;
          });

        var nAtRisk = patients.length;
        var surv = 1;
        var points = [{ x: 0, y: 1 }];

        for (var j = 0; j < orderedTimes.length; j += 1) {
          var time = orderedTimes[j];
          var bucket = byTime[String(time)];
          var d = bucket.events;
          var c = bucket.censored;

          if (nAtRisk > 0 && d > 0) {
            surv = surv * (1 - d / nAtRisk);
          }

          points.push({ x: time, y: surv });
          nAtRisk -= (d + c);
          if (nAtRisk < 0) {
            nAtRisk = 0;
          }
        }

        return {
          points: points,
          totalPatients: patients.length,
          median: computeMedian(points)
        };
      }

      function readPrecomputedCurve(params) {
        var times = readNumberList(params, ["kmtiempo", "kmtiempo", "tiempokm"]);
        var surv = readNumberList(params, ["kmsupervivencia", "kmsurv", "supervivenciakm"]);

        var size = Math.min(times.length, surv.length);
        if (size < 2) {
          return DEFAULT_CURVE;
        }

        var pairs = [];
        for (var i = 0; i < size; i += 1) {
          var t = toSafeNumber(times[i], Number.NaN);
          var s = toSafeNumber(surv[i], Number.NaN);
          if (!Number.isFinite(t) || !Number.isFinite(s)) {
            continue;
          }
          if (t < 0) {
            continue;
          }
          if (s < 0) {
            s = 0;
          }
          if (s > 1) {
            s = 1;
          }
          pairs.push({ x: t, y: s });
        }

        if (pairs.length < 2) {
          return DEFAULT_CURVE;
        }

        pairs.sort(function (a, b) {
          return a.x - b.x;
        });

        if (pairs[0].x > 0) {
          pairs.unshift({ x: 0, y: 1 });
        }

        return {
          points: pairs,
          totalPatients: toSafeNumber(getFirstParamValue(params, ["kmtotalpacientes", "kmtotal"]), 0),
          median: computeMedian(pairs)
        };
      }

      // Render switching logic:
      // - If raw rows arrive in URL, curve is computed inside the visual.
      // - If not, visual reads a pre-aggregated KM curve.
      function buildConfigFromQuery(params) {
        var rawRows = readRawRowsFromJson(params);
        if (!rawRows.length) {
          rawRows = readRawRowsFromColumns(params);
        }

        if (rawRows.length) {
          var patients = collapseRowsByPatient(rawRows);
          var computed = computeKaplanMeierFromPatients(patients);
          if (computed) {
            return computed;
          }
        }

        return readPrecomputedCurve(params);
      }

      function formatInteger(value) {
        return new Intl.NumberFormat("es-ES", { maximumFractionDigits: 0 }).format(value);
      }

      function formatMedian(value) {
        if (!Number.isFinite(value)) {
          return "--";
        }
        return new Intl.NumberFormat("es-ES", {
          minimumFractionDigits: value % 1 === 0 ? 0 : 1,
          maximumFractionDigits: 2
        }).format(value);
      }

      function setMeta(config) {
        dom.pacientes.textContent = "Pacientes: " + formatInteger(config.totalPatients || 0);
        dom.mediana.textContent = "Mediana: " + formatMedian(config.median) + " meses";
      }

      function showError(message) {
        dom.error.textContent = message;
        dom.error.style.display = "block";
      }

      function clearError() {
        dom.error.textContent = "";
        dom.error.style.display = "none";
      }

      function registerPlugins() {
        if (pluginRegistered || !window.Chart) {
          return;
        }

        window.Chart.register({
          id: "medianGuides",
          afterDatasetsDraw: function (chart, args, pluginOptions) {
            if (!pluginOptions || !Number.isFinite(pluginOptions.median)) {
              return;
            }

            var xScale = chart.scales.x;
            var yScale = chart.scales.y;
            if (!xScale || !yScale) {
              return;
            }

            var xMed = xScale.getPixelForValue(pluginOptions.median);
            var yHalf = yScale.getPixelForValue(0.5);
            var yBottom = yScale.getPixelForValue(0);
            var xZero = xScale.getPixelForValue(0);
            var ctx = chart.ctx;

            ctx.save();
            ctx.strokeStyle = "#c62828";
            ctx.lineWidth = 1.5;
            ctx.setLineDash([6, 4]);

            ctx.beginPath();
            ctx.moveTo(xZero, yHalf);
            ctx.lineTo(xMed, yHalf);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(xMed, yBottom);
            ctx.lineTo(xMed, yHalf);
            ctx.stroke();

            ctx.setLineDash([]);
            ctx.fillStyle = "#c62828";
            ctx.font = "600 11px Amazon Ember, Segoe UI, Arial, sans-serif";
            ctx.textAlign = "left";
            ctx.textBaseline = "bottom";
            ctx.fillText("Mediana: " + formatMedian(pluginOptions.median), xMed + 6, yHalf - 4);
            ctx.restore();
          }
        });

        pluginRegistered = true;
      }

      async function ensureChartJs() {
        if (window.Chart) {
          return;
        }

        await new Promise(function (resolve, reject) {
          var script = document.createElement("script");
          script.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js";
          script.async = true;
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }

      function destroyChart() {
        if (chartInstance) {
          chartInstance.destroy();
          chartInstance = null;
        }
      }

      function renderCurve(config) {
        destroyChart();
        clearError();

        if (!config.points || config.points.length < 2) {
          showError("No hay datos validos para dibujar la curva.");
          return;
        }

        chartInstance = new window.Chart(dom.canvas, {
          type: "line",
          data: {
            datasets: [
              {
                label: "S(t)",
                data: config.points,
                borderColor: "#313286",
                backgroundColor: "#313286",
                borderWidth: 3,
                pointRadius: 0,
                pointHoverRadius: 4,
                stepped: "after",
                tension: 0
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            parsing: true,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  title: function (items) {
                    return "Meses: " + formatMedian(items[0].parsed.x);
                  },
                  label: function (context) {
                    return "S(t): " + new Intl.NumberFormat("es-ES", {
                      minimumFractionDigits: 3,
                      maximumFractionDigits: 3
                    }).format(context.parsed.y);
                  }
                }
              },
              medianGuides: {
                median: config.median
              }
            },
            scales: {
              x: {
                type: "linear",
                title: {
                  display: true,
                  text: "Meses de supervivencia",
                  color: "#5d5d5d",
                  font: {
                    family: "Amazon Ember, Segoe UI, Arial, sans-serif",
                    weight: "700"
                  }
                },
                ticks: {
                  color: "#5d5d5d"
                },
                grid: {
                  color: "#d0d0d0",
                  borderDash: [2, 4]
                }
              },
              y: {
                min: 0,
                max: 1,
                title: {
                  display: true,
                  text: "Probabilidad de supervivencia",
                  color: "#5d5d5d",
                  font: {
                    family: "Amazon Ember, Segoe UI, Arial, sans-serif",
                    weight: "700"
                  }
                },
                ticks: {
                  color: "#5d5d5d"
                },
                grid: {
                  color: "#d0d0d0",
                  borderDash: [2, 4]
                }
              }
            }
          }
        });
      }

      async function init() {
        var params = readQueryParams();
        var config = buildConfigFromQuery(params);

        setMeta(config);

        try {
          await ensureChartJs();
          registerPlugins();
          renderCurve(config);
        } catch (error) {
          showError("No se pudo cargar Chart.js desde CDN.");
        }
}

      init();
    })();
  </script>
</body>
</html>
